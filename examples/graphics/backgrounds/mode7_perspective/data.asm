; Mode 7 Perspective - Asset data, VRAM loaders, and HDMA setup
;
; Two layers:
;   1. Ground: Mode 7 (1024x1024, 256 colors) at VRAM $0000
;   2. Sky:    Mode 3 BG2 (16 colors from ground palette) at VRAM $4000/$5000
;
; HDMA channels 1-4 switch between Mode 3 (sky) and Mode 7 (ground)
; mid-frame to create the perspective effect.

;----------------------------------------------------------------------
; Ground data (Mode 7 format: interleaved tilemap + tile pixels)
;----------------------------------------------------------------------
.section ".rodata1" superfree

ground_tiles:
.incbin "res/ground.pc7"
ground_tiles_end:

ground_map:
.incbin "res/ground.mp7"
ground_map_end:

ground_pal:
.incbin "res/ground.pal"
ground_pal_end:

.ends

;----------------------------------------------------------------------
; Sky data (Mode 3 format: regular 4bpp tiles + tilemap)
;----------------------------------------------------------------------
.section ".rodata2" superfree

sky_tiles:
.incbin "res/sky.pic"
sky_tiles_end:

sky_map:
.incbin "res/sky.map"
sky_map_end:

.ends

;----------------------------------------------------------------------
; HDMA tables (must be in a known section for correct bank byte)
;----------------------------------------------------------------------
.section ".hdma_tables" superfree

SKYLINEY = 96

; Channel 1: BGMODE switch ($2105)
; Format: [count] [mode_byte]
asm_ModeTable:
    .db SKYLINEY, $09       ; 96 scanlines: Mode 3 ($09 = mode 3 BG1 16px)
    .db 1, $07              ; rest: Mode 7 ($07)
    .db $00                 ; end

; Channel 2: Main screen enable ($212C)
; Format: [count] [tm_byte]
asm_BGTable:
    .db SKYLINEY, $12       ; 96 scanlines: OBJ + BG2
    .db 1, $11              ; rest: OBJ + BG1
    .db $00                 ; end

; Channel 3: Mode 7 horizontal scale (M7A at $211B)
; Format: [count] [scale_lo] [scale_hi]  (write-twice register)
; Generated by: scale = 512 / zoom, zoom starts at 1.0, increments by 0.025
asm_PerspectiveX:
    .db SKYLINEY, <256, >256  ; sky: scale = $0100
    .db $FF                   ; 127 scanlines, repeat mode
    .db 1, 0
    .db 0, 2
    .db 243, 1, 231, 1, 220, 1, 209, 1, 199, 1, 189, 1, 179, 1, 170, 1
    .db 161, 1, 153, 1, 145, 1, 137, 1, 130, 1, 123, 1, 116, 1, 109, 1
    .db 103, 1, 97, 1, 91, 1, 85, 1, 79, 1, 74, 1, 69, 1, 64, 1
    .db 59, 1, 54, 1, 49, 1, 45, 1, 40, 1, 36, 1, 32, 1, 28, 1
    .db 24, 1, 20, 1, 17, 1, 13, 1, 9, 1, 6, 1, 3, 1, 0, 1
    .db 252, 0, 249, 0, 246, 0, 243, 0, 240, 0, 238, 0, 235, 0, 232, 0
    .db 230, 0, 227, 0, 225, 0, 222, 0, 220, 0, 217, 0, 215, 0, 213, 0
    .db 211, 0, 208, 0, 206, 0, 204, 0, 202, 0, 200, 0, 198, 0, 196, 0
    .db 195, 0, 193, 0, 191, 0, 189, 0, 187, 0, 186, 0, 184, 0, 182, 0
    .db 181, 0, 179, 0, 178, 0, 176, 0, 175, 0, 173, 0, 172, 0, 170, 0
    .db 169, 0, 167, 0, 166, 0, 165, 0, 163, 0, 162, 0, 161, 0, 159, 0
    .db 158, 0, 157, 0, 156, 0, 155, 0, 153, 0, 152, 0, 151, 0, 150, 0
    .db 149, 0, 148, 0, 147, 0, 146, 0, 145, 0, 144, 0, 143, 0, 142, 0
    .db 141, 0, 140, 0, 139, 0, 138, 0, 137, 0, 136, 0, 135, 0, 134, 0
    .db 133, 0, 132, 0, 132, 0, 131, 0, 130, 0, 129, 0, 128, 0, 127, 0
    .db 127, 0, 126, 0, 125, 0, 124, 0, 124, 0, 123, 0

; Channel 4: Mode 7 vertical scale (M7D at $211E)
; Generated by: scale = 4096 / zoom, zoom starts at 1.0, increments by 0.05
asm_PerspectiveY:
    .db SKYLINEY, <256, >256  ; sky: scale = $0100
    .db $FF                   ; 127 scanlines, repeat mode
    .db 122, 0
    .db 0, 16
    .db 60, 15, 139, 14, 233, 13, 85, 13, 204, 12, 78, 12, 218, 11, 109, 11
    .db 8, 11, 170, 10, 82, 10, 0, 10, 178, 9, 105, 9, 36, 9, 227, 8
    .db 166, 8, 107, 8, 52, 8, 0, 8, 206, 7, 158, 7, 113, 7, 69, 7
    .db 28, 7, 244, 6, 206, 6, 170, 6, 135, 6, 102, 6, 70, 6, 39, 6
    .db 9, 6, 237, 5, 209, 5, 182, 5, 157, 5, 132, 5, 108, 5, 85, 5
    .db 62, 5, 41, 5, 20, 5, 0, 5, 236, 4, 217, 4, 198, 4, 180, 4
    .db 163, 4, 146, 4, 129, 4, 113, 4, 98, 4, 83, 4, 68, 4, 53, 4
    .db 39, 4, 26, 4, 12, 4, 0, 4, 243, 3, 231, 3, 218, 3, 207, 3
    .db 195, 3, 184, 3, 173, 3, 162, 3, 152, 3, 142, 3, 132, 3, 122, 3
    .db 112, 3, 103, 3, 94, 3, 85, 3, 76, 3, 67, 3, 59, 3, 51, 3
    .db 43, 3, 35, 3, 27, 3, 19, 3, 12, 3, 4, 3, 253, 2, 246, 2
    .db 239, 2, 232, 2, 226, 2, 219, 2, 212, 2, 206, 2, 200, 2, 194, 2
    .db 188, 2, 182, 2, 176, 2, 170, 2, 165, 2, 159, 2, 154, 2, 148, 2
    .db 143, 2, 138, 2, 133, 2, 127, 2, 123, 2, 118, 2, 113, 2, 108, 2
    .db 103, 2, 99, 2, 94, 2, 90, 2, 85, 2, 81, 2, 77, 2, 73, 2
    .db 68, 2, 64, 2, 60, 2, 56, 2, 52, 2, 49, 2

.ends

;----------------------------------------------------------------------
; Assembly helper: set up HDMA perspective and update scroll registers
;
; Called every frame from C. Configures HDMA channels 1-4 with correct
; bank bytes and writes Mode 7 scroll registers.
;
; void asm_setupHdmaPerspective(u16 sx, u16 sy)
; Stack: 5-6,s = sy, 7-8,s = sx (cproc right-to-left push)
;----------------------------------------------------------------------
.section ".hdma_setup" superfree

asm_setupHdmaPerspective:
    php
    rep #$30            ; 16-bit A and X/Y

    ; --- Read sx and sy from stack ---
    lda 7,s             ; sx
    sta.l tcc__r0       ; temp storage for sx
    lda 5,s             ; sy
    sta.l tcc__r1       ; temp storage for sy

    sep #$20            ; 8-bit A for register writes

    ; --- Mode 7 scroll registers (write low then high) ---
    ; M7HOFS ($210D) = sx
    lda.l tcc__r0       ; sx low
    sta $210D
    lda.l tcc__r0+1     ; sx high
    sta $210D

    ; M7VOFS ($210E) = sy
    lda.l tcc__r1       ; sy low
    sta $210E
    lda.l tcc__r1+1     ; sy high
    sta $210E

    ; BG2HOFS ($210F) = sx (sky scrolls with ground horizontally)
    lda.l tcc__r0       ; sx low
    sta $210F
    lda #$00
    sta $210F            ; high byte = 0 for BG2 scroll

    ; M7X ($211F) = sx + 128 (transformation center X)
    rep #$20
    lda.l tcc__r0
    clc
    adc #128
    sep #$20
    sta $211F           ; low
    xba
    sta $211F           ; high

    ; M7Y ($2120) = sy + 112 (transformation center Y)
    rep #$20
    lda.l tcc__r1
    clc
    adc #112
    sep #$20
    sta $2120           ; low
    xba
    sta $2120           ; high

    ; --- Disable HDMA before reconfiguring ---
    lda #$00
    sta $420C           ; REG_HDMAEN = 0

    ; --- Channel 1: Mode switch (1 byte to $2105) ---
    lda #$00            ; HDMA mode 0 (1 reg, 1 byte)
    sta $4310           ; DMAP1
    lda #$05            ; dest = $2105 (BGMODE)
    sta $4311           ; BBAD1
    ldx #asm_ModeTable
    stx $4312           ; A1T1 address
    lda #:asm_ModeTable
    sta $4314           ; A1B1 bank

    ; --- Channel 2: BG enable (1 byte to $212C) ---
    lda #$00
    sta $4320           ; DMAP2
    lda #$2C            ; dest = $212C (TM)
    sta $4321           ; BBAD2
    ldx #asm_BGTable
    stx $4322           ; A1T2 address
    lda #:asm_BGTable
    sta $4324           ; A1B2 bank

    ; --- Channel 3: M7A scale X (2 bytes, write twice to $211B) ---
    lda #$02            ; HDMA mode 2 (1 reg, write twice)
    sta $4330           ; DMAP3
    lda #$1B            ; dest = $211B (M7A)
    sta $4331           ; BBAD3
    ldx #asm_PerspectiveX
    stx $4332           ; A1T3 address
    lda #:asm_PerspectiveX
    sta $4334           ; A1B3 bank

    ; --- Channel 4: M7D scale Y (2 bytes, write twice to $211E) ---
    lda #$02
    sta $4340           ; DMAP4
    lda #$1E            ; dest = $211E (M7D)
    sta $4341           ; BBAD4
    ldx #asm_PerspectiveY
    stx $4342           ; A1T4 address
    lda #:asm_PerspectiveY
    sta $4344           ; A1B4 bank

    ; --- Enable HDMA channels 1-4 ---
    lda #$1E            ; bits 1-4 = channels 1,2,3,4
    sta $420C           ; REG_HDMAEN

    plp
    rtl
.ends

;----------------------------------------------------------------------
; Assembly loader: Mode 7 ground data to VRAM $0000
; Must be called during forced blank (INIDISP = $80)
;----------------------------------------------------------------------
.section ".mode7loader" superfree

asm_loadGroundData:
    php
    rep #$10            ; 16-bit index registers
    sep #$20            ; 8-bit accumulator

    ; Step 1: Load tilemap to VRAM low bytes
    lda #$00
    sta $2115           ; VMAIN = 0 (increment after low byte write)
    stz $2116           ; VMADDL = 0
    stz $2117           ; VMADDH = 0

    stz $4300           ; DMA mode 0
    lda #$18            ; B-bus = $2118 (VMDATAL)
    sta $4301
    ldx #ground_map
    stx $4302           ; Source address low
    lda #:ground_map
    sta $4304           ; Source bank
    ldx #(ground_map_end - ground_map)
    stx $4305           ; Transfer size
    lda #$01
    sta $420B           ; Start DMA channel 0

    ; Step 2: Load tile pixels to VRAM high bytes
    lda #$80
    sta $2115           ; VMAIN = $80 (increment after high byte write)
    stz $2116           ; VMADDL = 0
    stz $2117           ; VMADDH = 0

    stz $4300           ; DMA mode 0
    lda #$19            ; B-bus = $2119 (VMDATAH)
    sta $4301
    ldx #ground_tiles
    stx $4302           ; Source address low
    lda #:ground_tiles
    sta $4304           ; Source bank
    ldx #(ground_tiles_end - ground_tiles)
    stx $4305           ; Transfer size
    lda #$01
    sta $420B           ; Start DMA channel 0

    ; Step 3: Load full 256-color palette to CGRAM
    stz $2121           ; CGADD = 0
    stz $4300           ; DMA mode 0
    lda #$22            ; B-bus = $2122 (CGDATA)
    sta $4301
    ldx #ground_pal
    stx $4302
    lda #:ground_pal
    sta $4304
    ldx #(ground_pal_end - ground_pal)
    stx $4305
    lda #$01
    sta $420B           ; Start DMA channel 0

    ; Restore VMAIN for normal word access
    lda #$80
    sta $2115

    plp
    rtl
.ends

;----------------------------------------------------------------------
; Assembly loader: Sky tiles+map to VRAM $4000/$5000
; Must be called during forced blank (INIDISP = $80)
; Sky uses 16 colors from the ground palette (already loaded)
;----------------------------------------------------------------------
.section ".skyloader" superfree

asm_loadSkyData:
    php
    rep #$10            ; 16-bit index registers
    sep #$20            ; 8-bit accumulator

    ; Load sky tilemap to VRAM $4000
    lda #$80
    sta $2115           ; VMAIN = $80 (increment after high byte write)
    ldx #$4000
    stx $2116           ; VMADDR = $4000

    lda #$01            ; DMA mode 1 (2 bytes to consecutive registers)
    sta $4300
    lda #$18            ; B-bus = $2118 (VMDATAL), auto $2119 (VMDATAH)
    sta $4301
    ldx #sky_map
    stx $4302
    lda #:sky_map
    sta $4304
    ldx #(sky_map_end - sky_map)
    stx $4305
    lda #$01
    sta $420B           ; Start DMA channel 0

    ; Load sky tiles to VRAM $5000
    ldx #$5000
    stx $2116           ; VMADDR = $5000

    lda #$01            ; DMA mode 1
    sta $4300
    lda #$18
    sta $4301
    ldx #sky_tiles
    stx $4302
    lda #:sky_tiles
    sta $4304
    ldx #(sky_tiles_end - sky_tiles)
    stx $4305
    lda #$01
    sta $420B           ; Start DMA channel 0

    plp
    rtl
.ends
