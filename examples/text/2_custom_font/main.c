/**
 * @file main.c
 * @brief Custom Font Example for OpenSNES
 *
 * Displays text using a minimal built-in font.
 * Demonstrates BG tile-based text rendering.
 *
 * License: MIT
 */

typedef unsigned char u8;
typedef unsigned short u16;

/*---------------------------------------------------------------------------
 * SNES Hardware Registers
 *---------------------------------------------------------------------------*/

#define REG_INIDISP  (*(volatile u8*)0x2100)
#define REG_BGMODE   (*(volatile u8*)0x2105)
#define REG_BG1SC    (*(volatile u8*)0x2107)
#define REG_BG12NBA  (*(volatile u8*)0x210B)
#define REG_TM       (*(volatile u8*)0x212C)
#define REG_VMAIN    (*(volatile u8*)0x2115)
#define REG_VMADDL   (*(volatile u8*)0x2116)
#define REG_VMADDH   (*(volatile u8*)0x2117)
#define REG_VMDATAL  (*(volatile u8*)0x2118)
#define REG_VMDATAH  (*(volatile u8*)0x2119)
#define REG_CGADD    (*(volatile u8*)0x2121)
#define REG_CGDATA   (*(volatile u8*)0x2122)

/*---------------------------------------------------------------------------
 * Font Data (2bpp, 16 bytes per tile)
 * Characters: space, A-Z, 0-9, punctuation = 48 tiles
 *---------------------------------------------------------------------------*/

/* Tile indices:
 * 0 = space
 * 1-26 = A-Z
 * 27-36 = 0-9
 * 37 = !
 * 38 = .
 * 39 = :
 * 40 = -
 * 41 = =
 */

static const u8 font_tiles[] = {
    /* 0: Space */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 1: A */
    0x18,0x00, 0x3C,0x00, 0x66,0x00, 0x7E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 2: B */
    0x7C,0x00, 0x66,0x00, 0x7C,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x7C,0x00, 0x00,0x00,
    /* 3: C */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 4: D */
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x00,0x00,
    /* 5: E */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 6: F */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 7: G */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 8: H */
    0x66,0x00, 0x66,0x00, 0x7E,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 9: I */
    0x3C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x3C,0x00, 0x00,0x00,
    /* 10: J */
    0x1E,0x00, 0x0C,0x00, 0x0C,0x00, 0x0C,0x00,
    0x6C,0x00, 0x6C,0x00, 0x38,0x00, 0x00,0x00,
    /* 11: K */
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x70,0x00,
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x00,0x00,
    /* 12: L */
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 13: M */
    0xC6,0x00, 0xEE,0x00, 0xFE,0x00, 0xD6,0x00,
    0xC6,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 14: N */
    0x66,0x00, 0x76,0x00, 0x7E,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 15: O */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 16: P */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 17: Q */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x6A,0x00, 0x6C,0x00, 0x36,0x00, 0x00,0x00,
    /* 18: R */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x6C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 19: S */
    0x3C,0x00, 0x66,0x00, 0x70,0x00, 0x3C,0x00,
    0x0E,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 20: T */
    0x7E,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 21: U */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 22: V */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x3C,0x00, 0x3C,0x00, 0x18,0x00, 0x00,0x00,
    /* 23: W */
    0xC6,0x00, 0xC6,0x00, 0xD6,0x00, 0xFE,0x00,
    0xEE,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 24: X */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 25: Y */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 26: Z */
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 27: 0 */
    0x3C,0x00, 0x66,0x00, 0x6E,0x00, 0x76,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 28: 1 */
    0x18,0x00, 0x38,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x7E,0x00, 0x00,0x00,
    /* 29: 2 */
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 30: 3 */
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00,
    0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 31: 4 */
    0x0C,0x00, 0x1C,0x00, 0x3C,0x00, 0x6C,0x00,
    0x7E,0x00, 0x0C,0x00, 0x0C,0x00, 0x00,0x00,
    /* 32: 5 */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x06,0x00,
    0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 33: 6 */
    0x1C,0x00, 0x30,0x00, 0x60,0x00, 0x7C,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 34: 7 */
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 35: 8 */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 36: 9 */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3E,0x00,
    0x06,0x00, 0x0C,0x00, 0x38,0x00, 0x00,0x00,
    /* 37: ! */
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x00,0x00, 0x18,0x00, 0x00,0x00,
    /* 38: . */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 39: : */
    0x00,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x18,0x00, 0x18,0x00, 0x00,0x00, 0x00,0x00,
    /* 40: - */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x7E,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 41: = */
    0x00,0x00, 0x00,0x00, 0x7E,0x00, 0x00,0x00,
    0x7E,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
};

#define FONT_TILE_COUNT 42
#define FONT_SIZE (FONT_TILE_COUNT * 16)

/*---------------------------------------------------------------------------
 * Pre-encoded Messages
 *---------------------------------------------------------------------------*/

/* "=== CUSTOM FONT ===" */
static const u8 msg_title[] = {
    41,41,41, 0, 3,21,19,20,15,13, 0, 6,15,14,20, 0, 41,41,41, 0xFF
};

/* "HELLO WORLD!" */
static const u8 msg_hello[] = {
    8,5,12,12,15, 0, 23,15,18,12,4, 37, 0xFF
};

/* "ABCDEFGHIJ" */
static const u8 msg_abc1[] = {
    1,2,3,4,5,6,7,8,9,10, 0xFF
};

/* "KLMNOPQRST" */
static const u8 msg_abc2[] = {
    11,12,13,14,15,16,17,18,19,20, 0xFF
};

/* "UVWXYZ" */
static const u8 msg_abc3[] = {
    21,22,23,24,25,26, 0xFF
};

/* "0123456789" */
static const u8 msg_numbers[] = {
    27,28,29,30,31,32,33,34,35,36, 0xFF
};

/* "OPENSNES" */
static const u8 msg_opensnes[] = {
    15,16,5,14,19,14,5,19, 0xFF
};

/*---------------------------------------------------------------------------
 * Functions
 *---------------------------------------------------------------------------*/

int main(void) {
    u16 i;
    u16 addr;
    u8 tile;
    const u8 *msg;

    /* Configure PPU */
    REG_BGMODE = 0x00;
    REG_BG1SC = 0x04;
    REG_BG12NBA = 0x00;

    /* Load font tiles to VRAM $0000 */
    REG_VMAIN = 0x80;
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x00;

    for (i = 0; i < FONT_SIZE; i += 2) {
        REG_VMDATAL = font_tiles[i];
        REG_VMDATAH = font_tiles[i + 1];
    }

    /* Set palette */
    REG_CGADD = 0;
    REG_CGDATA = 0x00; REG_CGDATA = 0x28;  /* Dark blue */
    REG_CGDATA = 0xFF; REG_CGDATA = 0x7F;  /* White */

    /* Clear tilemap */
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x04;
    for (i = 0; i < 1024; i++) {
        REG_VMDATAL = 0;
        REG_VMDATAH = 0;
    }

    /* Print title at row 3 */
    addr = 0x0400 + 3*32 + 6;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_title;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print HELLO WORLD at row 7 */
    addr = 0x0400 + 7*32 + 10;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_hello;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print alphabet row 1 at row 12 */
    addr = 0x0400 + 12*32 + 11;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_abc1;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print alphabet row 2 at row 13 */
    addr = 0x0400 + 13*32 + 11;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_abc2;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print alphabet row 3 at row 14 */
    addr = 0x0400 + 14*32 + 13;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_abc3;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print numbers at row 17 */
    addr = 0x0400 + 17*32 + 11;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_numbers;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Print OPENSNES at row 21 */
    addr = 0x0400 + 21*32 + 12;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    msg = msg_opensnes;
    i = 0;
    while (msg[i] != 0xFF) { REG_VMDATAL = msg[i]; REG_VMDATAH = 0; i++; }

    /* Enable BG1 and turn on screen */
    REG_TM = 0x01;
    REG_INIDISP = 0x0F;

    while (1) {}
    return 0;
}
