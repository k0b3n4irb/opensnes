/**
 * Simple test - no runtime functions
 */

typedef unsigned char u8;
typedef unsigned short u16;

#define REG_INIDISP  (*(volatile u8*)0x2100)
#define REG_BGMODE   (*(volatile u8*)0x2105)
#define REG_BG1SC    (*(volatile u8*)0x2107)
#define REG_BG12NBA  (*(volatile u8*)0x210B)
#define REG_TM       (*(volatile u8*)0x212C)
#define REG_VMAIN    (*(volatile u8*)0x2115)
#define REG_VMADDL   (*(volatile u8*)0x2116)
#define REG_VMADDH   (*(volatile u8*)0x2117)
#define REG_VMDATAL  (*(volatile u8*)0x2118)
#define REG_VMDATAH  (*(volatile u8*)0x2119)
#define REG_CGADD    (*(volatile u8*)0x2121)
#define REG_CGDATA   (*(volatile u8*)0x2122)

/* Minimal font: space, A, B, C, 0, 1, 2 (indices 0-6) */
static const u8 font_tiles[] = {
    /* 0: Space */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 1: A */
    0x18,0x00, 0x3C,0x00, 0x66,0x00, 0x7E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 2: B */
    0x7C,0x00, 0x66,0x00, 0x7C,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x7C,0x00, 0x00,0x00,
    /* 3: C */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 4: 0 */
    0x3C,0x00, 0x66,0x00, 0x6E,0x00, 0x76,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 5: 1 */
    0x18,0x00, 0x38,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x7E,0x00, 0x00,0x00,
    /* 6: 2 */
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
};

#define FONT_SIZE (7 * 16)  /* 7 tiles * 16 bytes */

int main(void) {
    u16 i;

    /* Set up Mode 0 */
    REG_BGMODE = 0x00;
    REG_BG1SC = 0x04;
    REG_BG12NBA = 0x00;

    /* Load font tiles */
    REG_VMAIN = 0x80;
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x00;
    for (i = 0; i < FONT_SIZE; i = i + 2) {
        REG_VMDATAL = font_tiles[i];
        REG_VMDATAH = font_tiles[i + 1];
    }

    /* Set palette */
    REG_CGADD = 0;
    REG_CGDATA = 0x00; REG_CGDATA = 0x28;
    REG_CGDATA = 0xFF; REG_CGDATA = 0x7F;

    /* Clear tilemap */
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x04;
    for (i = 0; i < 1024; i = i + 1) {
        REG_VMDATAL = 0;
        REG_VMDATAH = 0;
    }

    /* Write "ABC 012" at row 10, col 10 */
    /* Address = 0x0400 + 10*32 + 10 = 0x0400 + 320 + 10 = 0x054A */
    REG_VMADDL = 0x4A;
    REG_VMADDH = 0x05;
    REG_VMDATAL = 1; REG_VMDATAH = 0;  /* A */
    REG_VMDATAL = 2; REG_VMDATAH = 0;  /* B */
    REG_VMDATAL = 3; REG_VMDATAH = 0;  /* C */
    REG_VMDATAL = 0; REG_VMDATAH = 0;  /* space */
    REG_VMDATAL = 4; REG_VMDATAH = 0;  /* 0 */
    REG_VMDATAL = 5; REG_VMDATAH = 0;  /* 1 */
    REG_VMDATAL = 6; REG_VMDATAH = 0;  /* 2 */

    /* Enable display */
    REG_TM = 0x01;
    REG_INIDISP = 0x0F;

    while (1) {}
    return 0;
}
