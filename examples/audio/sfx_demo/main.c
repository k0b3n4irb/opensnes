/**
 * SFX Demo - Bare-metal SPC700 sound effect
 *
 * Uploads a custom SPC700 driver and BRR sample (tada.brr),
 * then plays it when button A is pressed.
 *
 * Controls:
 *   A - Play sound effect
 */

#include <snes.h>

/* Audio functions from spc.asm */
extern void spc_init(void);
extern void spc_play(void);

/* Font tiles (2bpp, 16 bytes per tile)
 * Tile indices: 0=space, 1-26=A-Z, 27=-, 28=:
 */
static const u8 font_tiles[] = {
    /* 0: Space */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 1: A */
    0x18,0x00, 0x3C,0x00, 0x66,0x00, 0x7E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 2: B */
    0x7C,0x00, 0x66,0x00, 0x7C,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x7C,0x00, 0x00,0x00,
    /* 3: C */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 4: D */
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x00,0x00,
    /* 5: E */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 6: F */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 7: G */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 8: H */
    0x66,0x00, 0x66,0x00, 0x7E,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 9: I */
    0x3C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x3C,0x00, 0x00,0x00,
    /* 10: J */
    0x1E,0x00, 0x0C,0x00, 0x0C,0x00, 0x0C,0x00,
    0x6C,0x00, 0x6C,0x00, 0x38,0x00, 0x00,0x00,
    /* 11: K */
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x70,0x00,
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x00,0x00,
    /* 12: L */
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 13: M */
    0xC6,0x00, 0xEE,0x00, 0xFE,0x00, 0xD6,0x00,
    0xC6,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 14: N */
    0x66,0x00, 0x76,0x00, 0x7E,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 15: O */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 16: P */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 17: Q */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x6A,0x00, 0x6C,0x00, 0x36,0x00, 0x00,0x00,
    /* 18: R */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x6C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 19: S */
    0x3C,0x00, 0x66,0x00, 0x70,0x00, 0x3C,0x00,
    0x0E,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 20: T */
    0x7E,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 21: U */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 22: V */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x3C,0x00, 0x3C,0x00, 0x18,0x00, 0x00,0x00,
    /* 23: W */
    0xC6,0x00, 0xC6,0x00, 0xD6,0x00, 0xFE,0x00,
    0xEE,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 24: X */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 25: Y */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 26: Z */
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 27: - */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x7E,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 28: : */
    0x00,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x18,0x00, 0x18,0x00, 0x00,0x00, 0x00,0x00,
};

#define FONT_SIZE (29 * 16)

/* Pre-encoded messages (tile indices) */
/* "SFX DEMO" */
static const u8 msg_title[] = { 19,6,24, 0, 4,5,13,15, 0xFF };
/* "PRESS A TO PLAY" */
static const u8 msg_press[] = { 16,18,5,19,19, 0, 1, 0, 20,15, 0, 16,12,1,25, 0xFF };

static void print_msg(u16 addr, const u8 *msg) {
    u16 i;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    i = 0;
    while (msg[i] != 0xFF) {
        REG_VMDATAL = msg[i];
        REG_VMDATAH = 0;
        i++;
    }
}

int main(void) {
    u16 pad;
    u16 pad_prev;
    u16 pad_pressed;
    u16 i;

    /* Initialize console hardware */
    consoleInit();

    /* Set Mode 0 (4 BG layers, all 2bpp) */
    setMode(BG_MODE0, 0);

    /* Configure BG1 for text display */
    REG_BG1SC = 0x04;   /* Tilemap at $0400, 32x32 */
    REG_BG12NBA = 0x00; /* BG1 tiles at $0000 */

    /* Load font tiles to VRAM $0000 */
    REG_VMAIN = 0x80;
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x00;
    for (i = 0; i < FONT_SIZE; i += 2) {
        REG_VMDATAL = font_tiles[i];
        REG_VMDATAH = font_tiles[i + 1];
    }

    /* Set palette: dark blue background, white text */
    REG_CGADD = 0;
    REG_CGDATA = 0x00; REG_CGDATA = 0x28;  /* Dark blue */
    REG_CGDATA = 0xFF; REG_CGDATA = 0x7F;  /* White */

    /* Clear tilemap */
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x04;
    for (i = 0; i < 1024; i++) {
        REG_VMDATAL = 0;
        REG_VMDATAH = 0;
    }

    /* Print messages */
    print_msg(0x0400 + 10*32 + 12, msg_title);
    print_msg(0x0400 + 13*32 + 8, msg_press);

    /* Enable BG1 on main screen */
    REG_TM = TM_BG1;

    /* Initialize audio - disable NMI during upload (timing-critical) */
    REG_NMITIMEN = 0x00;
    spc_init();
    REG_NMITIMEN = 0x81;  /* Re-enable NMI + auto-joypad */

    /* Turn on screen */
    setScreenOn();

    /* Initialize pad_prev */
    WaitForVBlank();
    while (REG_HVBJOY & 0x01) {}
    pad_prev = REG_JOY1L | (REG_JOY1H << 8);

    /* Main loop */
    while (1) {
        WaitForVBlank();

        while (REG_HVBJOY & 0x01) {}
        pad = REG_JOY1L | (REG_JOY1H << 8);
        pad_pressed = pad & ~pad_prev;
        pad_prev = pad;

        if (pad == 0xFFFF) pad_pressed = 0;

        if (pad_pressed & KEY_A) {
            spc_play();
        }
    }

    return 0;
}
