/**
 * @file main.c
 * @brief SNESMOD Sound Effects Demo
 *
 * Demonstrates sound effect playback using SNESMOD without music.
 * Each button plays a different sound effect.
 *
 * Controls:
 *   A      - Play "Tada" effect
 *   B      - Play "Strings" effect
 *   X      - Play "Piano" effect
 *   Y      - Play "Marimba" effect
 *   L/R    - Play "Cowbell" effect
 *   Left/Right - Change pitch
 */

#include <snes.h>
#include <snes/snesmod.h>
#include "soundbank.h"

/* Font tiles (2bpp, 16 bytes per tile) */
static const u8 font_tiles[] = {
    /* 0: Space */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 1: A */
    0x18,0x00, 0x3C,0x00, 0x66,0x00, 0x7E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 2: B */
    0x7C,0x00, 0x66,0x00, 0x7C,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x7C,0x00, 0x00,0x00,
    /* 3: C */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 4: D */
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x00,0x00,
    /* 5: E */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 6: F */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 7: G */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 8: H */
    0x66,0x00, 0x66,0x00, 0x7E,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 9: I */
    0x3C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x3C,0x00, 0x00,0x00,
    /* 10: J */
    0x1E,0x00, 0x0C,0x00, 0x0C,0x00, 0x0C,0x00,
    0x6C,0x00, 0x6C,0x00, 0x38,0x00, 0x00,0x00,
    /* 11: K */
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x70,0x00,
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x00,0x00,
    /* 12: L */
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 13: M */
    0xC6,0x00, 0xEE,0x00, 0xFE,0x00, 0xD6,0x00,
    0xC6,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 14: N */
    0x66,0x00, 0x76,0x00, 0x7E,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 15: O */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 16: P */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 17: Q */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x6A,0x00, 0x6C,0x00, 0x36,0x00, 0x00,0x00,
    /* 18: R */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x6C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 19: S */
    0x3C,0x00, 0x66,0x00, 0x70,0x00, 0x3C,0x00,
    0x0E,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 20: T */
    0x7E,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 21: U */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 22: V */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x3C,0x00, 0x3C,0x00, 0x18,0x00, 0x00,0x00,
    /* 23: W */
    0xC6,0x00, 0xC6,0x00, 0xD6,0x00, 0xFE,0x00,
    0xEE,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 24: X */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 25: Y */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 26: Z */
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 27-36: 0-9 */
    0x3C,0x00, 0x66,0x00, 0x6E,0x00, 0x76,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x18,0x00, 0x38,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x7E,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00, 0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00, 0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x0C,0x00, 0x1C,0x00, 0x3C,0x00, 0x6C,0x00, 0x7E,0x00, 0x0C,0x00, 0x0C,0x00, 0x00,0x00,
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x06,0x00, 0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x1C,0x00, 0x30,0x00, 0x60,0x00, 0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3E,0x00, 0x06,0x00, 0x0C,0x00, 0x38,0x00, 0x00,0x00,
    /* 37: - */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x7E,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 38: / */
    0x06,0x00, 0x0C,0x00, 0x18,0x00, 0x30,0x00,
    0x60,0x00, 0xC0,0x00, 0x80,0x00, 0x00,0x00,
    /* 39: : */
    0x00,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x18,0x00, 0x18,0x00, 0x00,0x00, 0x00,0x00,
};

#define FONT_SIZE (40 * 16)

/* Pre-encoded messages */
static const u8 msg_title[] = { 19,14,5,19,13,15,4, 0, 19,6,24, 0, 5,24,1,13,16,12,5, 0xFF };  /* "SNESMOD SFX EXAMPLE" */
static const u8 msg_controls[] = { 3,15,14,20,18,15,12,19,39, 0xFF };  /* "CONTROLS:" */
static const u8 msg_a[] = { 1, 0,37,0, 20,1,4,1, 0xFF };  /* "A - TADA" */
static const u8 msg_b[] = { 2, 0,37,0, 19,20,18,9,14,7,19, 0xFF };  /* "B - STRINGS" */
static const u8 msg_x[] = { 24, 0,37,0, 16,9,1,14,15, 0xFF };  /* "X - PIANO" */
static const u8 msg_y[] = { 25, 0,37,0, 13,1,18,9,13,2,1, 0xFF };  /* "Y - MARIMBA" */
static const u8 msg_lr[] = { 12,38,18, 0,37,0, 3,15,23,2,5,12,12, 0xFF };  /* "L/R - COWBELL" */
static const u8 msg_dpad[] = { 12,5,6,20,38,18,9,7,8,20, 0,37,0, 16,9,20,3,8, 0xFF };  /* "LEFT/RIGHT - PITCH" */
static const u8 msg_pitch_low[] = { 16,9,20,3,8,39, 0, 12,15,23, 0, 0, 0, 0, 0xFF };  /* "PITCH: LOW" */
static const u8 msg_pitch_norm[] = { 16,9,20,3,8,39, 0, 14,15,18,13,1,12, 0xFF };  /* "PITCH: NORMAL" */
static const u8 msg_pitch_high[] = { 16,9,20,3,8,39, 0, 8,9,7,8, 0, 0, 0xFF };  /* "PITCH: HIGH" */

static void print_msg(u16 addr, const u8 *msg) {
    u16 i;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    i = 0;
    while (msg[i] != 0xFF) {
        REG_VMDATAL = msg[i];
        REG_VMDATAH = 0;
        i++;
    }
}

/* Effect IDs - must match soundbank.h */
#define SFX_TADA      0
#define SFX_STRINGS   1
#define SFX_PIANO     2
#define SFX_MARIMBA   3
#define SFX_COWBELL   4

#define NUM_EFFECTS   5

int main(void) {
    u16 pad;
    u16 pad_pressed;
    u16 pad_prev;
    u16 pitch;
    u8 pitch_mode;  /* 0=low, 1=normal, 2=high */
    u16 i;

    /* Initialize console hardware */
    consoleInit();

    /* Set Mode 0 */
    setMode(BG_MODE0, 0);

    /* Configure BG1 for text display */
    REG_BG1SC = 0x04;
    REG_BG12NBA = 0x00;

    /* Load font tiles to VRAM $0000 */
    REG_VMAIN = 0x80;
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x00;
    for (i = 0; i < FONT_SIZE; i += 2) {
        REG_VMDATAL = font_tiles[i];
        REG_VMDATAH = font_tiles[i + 1];
    }

    /* Set palette */
    REG_CGADD = 0;
    REG_CGDATA = 0x00; REG_CGDATA = 0x28;  /* Dark blue */
    REG_CGDATA = 0xFF; REG_CGDATA = 0x7F;  /* White */

    /* Clear tilemap */
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x04;
    for (i = 0; i < 1024; i++) {
        REG_VMDATAL = 0;
        REG_VMDATAH = 0;
    }

    /* Print messages */
    print_msg(0x0400 + 2*32 + 6, msg_title);
    print_msg(0x0400 + 5*32 + 5, msg_controls);
    print_msg(0x0400 + 7*32 + 7, msg_a);
    print_msg(0x0400 + 8*32 + 7, msg_b);
    print_msg(0x0400 + 9*32 + 7, msg_x);
    print_msg(0x0400 + 10*32 + 7, msg_y);
    print_msg(0x0400 + 11*32 + 7, msg_lr);
    print_msg(0x0400 + 12*32 + 7, msg_dpad);
    print_msg(0x0400 + 15*32 + 7, msg_pitch_norm);

    /* Enable BG1 on main screen */
    REG_TM = TM_BG1;

    /* Initialize SNESMOD */
    snesmodInit();
    snesmodSetSoundbank(SOUNDBANK_BANK);

    /* Load all sound effects */
    for (i = 0; i < NUM_EFFECTS; i++) {
        snesmodLoadEffect(i);
    }

    /* Turn on screen */
    setScreenOn();

    /* Initialize variables */
    pitch_mode = 1;  /* Normal */
    pitch = SNESMOD_PITCH_NORMAL;

    /* Initialize pad_prev */
    WaitForVBlank();
    while (REG_HVBJOY & 0x01) {}
    pad_prev = REG_JOY1L | (REG_JOY1H << 8);

    /* Main loop */
    while (1) {
        WaitForVBlank();
        snesmodProcess();

        while (REG_HVBJOY & 0x01) {}
        pad = REG_JOY1L | (REG_JOY1H << 8);
        pad_pressed = pad & ~pad_prev;
        pad_prev = pad;

        if (pad == 0xFFFF) pad_pressed = 0;

        /* Change pitch with Left/Right */
        if (pad_pressed & KEY_LEFT) {
            if (pitch_mode > 0) {
                pitch_mode--;
                if (pitch_mode == 0) {
                    pitch = SNESMOD_PITCH_LOW;
                    print_msg(0x0400 + 15*32 + 7, msg_pitch_low);
                } else {
                    pitch = SNESMOD_PITCH_NORMAL;
                    print_msg(0x0400 + 15*32 + 7, msg_pitch_norm);
                }
            }
        }
        if (pad_pressed & KEY_RIGHT) {
            if (pitch_mode < 2) {
                pitch_mode++;
                if (pitch_mode == 1) {
                    pitch = SNESMOD_PITCH_NORMAL;
                    print_msg(0x0400 + 15*32 + 7, msg_pitch_norm);
                } else {
                    pitch = SNESMOD_PITCH_HIGH;
                    print_msg(0x0400 + 15*32 + 7, msg_pitch_high);
                }
            }
        }

        /* Play effects on button press */
        if (pad_pressed & KEY_A) {
            snesmodPlayEffect(SFX_TADA, 127, 128, pitch);
        }
        if (pad_pressed & KEY_B) {
            snesmodPlayEffect(SFX_STRINGS, 127, 128, pitch);
        }
        if (pad_pressed & KEY_X) {
            snesmodPlayEffect(SFX_PIANO, 127, 128, pitch);
        }
        if (pad_pressed & KEY_Y) {
            snesmodPlayEffect(SFX_MARIMBA, 127, 128, pitch);
        }
        if ((pad_pressed & KEY_L) || (pad_pressed & KEY_R)) {
            snesmodPlayEffect(SFX_COWBELL, 127, 128, pitch);
        }
    }

    return 0;
}
