# SNESMOD HiROM

> Tracker music playback in HiROM mode. Same SNESMOD API, different ROM layout.
> If the music plays, HiROM works.

![Screenshot](screenshot.png)

## Controls

| Button | Action |
|--------|--------|
| A | Play music |
| B | Stop |
| X | Pause / Resume |
| L / R | Volume down / up |
| Start | Fade out |

## Build & Run

```bash
make -C examples/audio/snesmod_hirom
# Open hirom_music.sfc in Mesen2
```

## What You'll Learn

- What HiROM is and why you'd use it (64KB banks vs. 32KB)
- That SNESMOD works identically in both LoROM and HiROM — the API doesn't change
- How `smconv` converts Impulse Tracker music into a soundbank for the SPC700
- The SNESMOD playback loop: `snesmodProcess()` must be called every frame

---

## Walkthrough

### 1. LoROM vs. HiROM — One Sentence

LoROM maps ROM in 32KB banks (`$8000`-`$FFFF`). HiROM maps ROM in 64KB banks
(`$0000`-`$FFFF`). HiROM gives you larger contiguous address space per bank, which
matters for big data blobs like soundbanks or level maps. That's it — the CPU doesn't
care, the code is the same, only the linker configuration changes.

### 2. Setting Up SNESMOD

Four calls at startup, same as the LoROM version:

```c
snesmodInit();                          /* Upload SPC700 driver */
snesmodSetSoundbank(SOUNDBANK_BANK);    /* Tell driver where the soundbank lives */
snesmodLoadModule(MOD_POLLEN8);         /* Load the music module into SPC RAM */
snesmodPlay(0);                         /* Start playing from position 0 */
```

`SOUNDBANK_BANK` and `MOD_POLLEN8` are constants generated by `smconv` in `soundbank.h`.
The bank number is the same in both LoROM and HiROM — the SNESMOD library handles
the address mapping internally.

> **Why `snesmodInit()` first?** It uploads the SNESMOD driver to the SPC700's 64KB RAM.
> This takes several frames (the SPC700 boot ROM accepts data byte-by-byte through 4
> shared ports). Nothing else can happen until the driver is running.

### 3. The Main Loop

Every frame, one mandatory call:

```c
while (1) {
    WaitForVBlank();
    snesmodProcess();   /* Feed the SPC700 — never skip this */

    pad = REG_JOY1L | (REG_JOY1H << 8);
    pad_pressed = pad & ~pad_prev;
    pad_prev = pad;

    if (pad_pressed & KEY_A) snesmodPlay(0);
    if (pad_pressed & KEY_B) snesmodStop();
    /* ... volume, pause, fade ... */
}
```

`snesmodProcess()` is the heartbeat. It sends queued commands and streaming data to the
SPC700 through the port registers. Skip it for a few frames and the music stutters.
Skip it for longer and the SPC700 runs out of data and goes silent.

### 4. Volume and Fade

```c
if (pad_pressed & KEY_R) {
    if (volume <= 117) volume += 10;
    else volume = 127;
    snesmodSetModuleVolume(volume);
}

if (pad_pressed & KEY_START) {
    snesmodFadeVolume(0, 4);  /* Fade to silence over ~4 process cycles */
}
```

Volume is 0-127. `snesmodFadeVolume(target, speed)` smoothly interpolates — the speed
parameter controls how many `snesmodProcess()` calls it takes per step.

### 5. The Text Display

The rest of the code is a simple text UI — a 40-character font loaded to VRAM with
pre-encoded message arrays, showing the controls on screen. Same technique as
[Hello World](../../text/hello_world/) and [Custom Font](../../text/custom_font/).

---

## Tips & Tricks

- **No sound at all?** Make sure `snesmodInit()` runs before any other SNESMOD call.
  Also check that `SOUNDBANK_BANK` matches the bank where the soundbank was placed
  by the linker.

- **Music stutters or cuts out?** You're not calling `snesmodProcess()` every frame.
  It must run 60 times per second, without exception.

- **Works in LoROM but not HiROM?** The soundbank might be too large for one bank.
  Check the `.sym` file to verify the soundbank fits within its assigned bank.

---

## Go Further

- **Add sound effects:** SNESMOD supports SFX alongside music. Use `snesmodPlaySFX()`
  to trigger samples on a dedicated voice. See [SNESMOD SFX](../snesmod_sfx/) for
  the pattern.

- **Try your own music:** Replace `music/pollen8.it` with any Impulse Tracker `.it` file.
  The `smconv` tool handles the conversion automatically.

- **Compare with bare-metal audio:** [SFX Demo](../sfx_demo/) shows how to upload a
  custom SPC700 driver by hand. SNESMOD does all of that for you — but understanding
  the low-level approach helps debug audio issues.

---

## Under the Hood: The Build

### The Makefile

```makefile
TARGET         := hirom_music.sfc
USE_LIB        := 1
USE_SNESMOD    := 1
USE_HIROM      := 1
LIB_MODULES    := console sprite dma input
SOUNDBANK_SRC  := music/pollen8.it
```

Three flags do the heavy lifting:
- `USE_SNESMOD := 1` — enables the SNESMOD audio pipeline
- `USE_HIROM := 1` — switches to 64KB bank layout
- `SOUNDBANK_SRC` — points to the Impulse Tracker source file

### The smconv Tool (Audio Conversion)

When `USE_SNESMOD` is enabled, the build system runs `smconv`:

```bash
smconv -s -o soundbank -b 1 -n -p soundbank music/pollen8.it
```

| Flag | Meaning |
|------|---------|
| `-s` | SNES output format |
| `-o soundbank` | Output filename prefix |
| `-b 1` | Place soundbank in ROM bank 1 |
| `-n` | No module names in output (saves space) |
| `-p soundbank` | Generate soundbank.h with C constants |

`smconv` reads the `.it` file (instruments, patterns, samples) and produces:
- `soundbank.bnk` — binary blob with all audio data
- `soundbank.asm` — assembly wrapper that places the blob in the right ROM bank
- `soundbank.h` — C header with `MOD_POLLEN8`, `SOUNDBANK_BANK`, etc.

The soundbank gets linked into the ROM at bank 1. At runtime, `snesmodSetSoundbank(1)`
tells the SPC700 driver where to find it.

### What HiROM Changes in the Build

| Aspect | LoROM | HiROM |
|--------|-------|-------|
| Bank size | 32KB | 64KB |
| ROM header | `LOROM` | `HIROM` + reserved lower half |
| Linker config | `.MEMORYMAP SLOTSIZE $8000` | `.MEMORYMAP SLOTSIZE $10000` |
| Soundbank placement | Same (`BANK 1`) | Same (`BANK 1`) |
| C code | Identical | Identical |

The C source is byte-for-byte identical to the LoROM version (`snesmod_music/`).
Only the Makefile flags and the ROM header template change.

---

## Technical Reference

| Register | Address | Role in this example |
|----------|---------|---------------------|
| APUIO0-3 | $2140-43 | Communication ports to SPC700 (used by SNESMOD internally) |
| BGMODE   | $2105   | Mode 0 (text display) |
| BG1SC    | $2107   | BG1 tilemap at $0400 |
| TM       | $212C   | Enable BG1 |

## Files

| File | What's in it |
|------|-------------|
| `main.c` | Text UI, SNESMOD init, playback controls (~267 lines) |
| `music/pollen8.it` | Impulse Tracker music module (29 KB) |
| `soundbank.h` | Generated: module IDs, SFX IDs, bank number |
| `soundbank.asm` | Generated: soundbank binary placement |
| `project_hdr.asm` | HiROM ROM header and interrupt vectors |
| `Makefile` | `USE_SNESMOD := 1`, `USE_HIROM := 1` |
