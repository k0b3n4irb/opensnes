/**
 * @file main.c
 * @brief SNESMOD Music â€” Tracker Music Playback
 *
 * Demonstrates tracker-based music playback using SNESMOD.
 *
 * Controls:
 *   A      - Play music
 *   B      - Stop music
 *   X      - Pause/Resume
 *   L/R    - Volume down/up
 *   START  - Fade out
 */

#include <snes.h>
#include <snes/snesmod.h>
#include "soundbank.h"

/* Font tiles (2bpp, 16 bytes per tile)
 * Tile indices: 0=space, 1-26=A-Z, 27-36=0-9, 37=!, 38=., 39=:, 40=-, 41=/, 42=( 43=)
 */
static const u8 font_tiles[] = {
    /* 0: Space */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 1: A */
    0x18,0x00, 0x3C,0x00, 0x66,0x00, 0x7E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 2: B */
    0x7C,0x00, 0x66,0x00, 0x7C,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x7C,0x00, 0x00,0x00,
    /* 3: C */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 4: D */
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x00,0x00,
    /* 5: E */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 6: F */
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 7: G */
    0x3C,0x00, 0x66,0x00, 0x60,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 8: H */
    0x66,0x00, 0x66,0x00, 0x7E,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 9: I */
    0x3C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x3C,0x00, 0x00,0x00,
    /* 10: J */
    0x1E,0x00, 0x0C,0x00, 0x0C,0x00, 0x0C,0x00,
    0x6C,0x00, 0x6C,0x00, 0x38,0x00, 0x00,0x00,
    /* 11: K */
    0x66,0x00, 0x6C,0x00, 0x78,0x00, 0x70,0x00,
    0x78,0x00, 0x6C,0x00, 0x66,0x00, 0x00,0x00,
    /* 12: L */
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x60,0x00,
    0x60,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 13: M */
    0xC6,0x00, 0xEE,0x00, 0xFE,0x00, 0xD6,0x00,
    0xC6,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 14: N */
    0x66,0x00, 0x76,0x00, 0x7E,0x00, 0x6E,0x00,
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 15: O */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 16: P */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x60,0x00, 0x60,0x00, 0x60,0x00, 0x00,0x00,
    /* 17: Q */
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x6A,0x00, 0x6C,0x00, 0x36,0x00, 0x00,0x00,
    /* 18: R */
    0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x7C,0x00,
    0x6C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 19: S */
    0x3C,0x00, 0x66,0x00, 0x70,0x00, 0x3C,0x00,
    0x0E,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 20: T */
    0x7E,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 21: U */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    /* 22: V */
    0x66,0x00, 0x66,0x00, 0x66,0x00, 0x66,0x00,
    0x3C,0x00, 0x3C,0x00, 0x18,0x00, 0x00,0x00,
    /* 23: W */
    0xC6,0x00, 0xC6,0x00, 0xD6,0x00, 0xFE,0x00,
    0xEE,0x00, 0xC6,0x00, 0xC6,0x00, 0x00,0x00,
    /* 24: X */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x00,0x00,
    /* 25: Y */
    0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x18,0x00,
    0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    /* 26: Z */
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00,
    0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    /* 27-36: 0-9 */
    0x3C,0x00, 0x66,0x00, 0x6E,0x00, 0x76,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x18,0x00, 0x38,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x7E,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00, 0x30,0x00, 0x60,0x00, 0x7E,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x06,0x00, 0x1C,0x00, 0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x0C,0x00, 0x1C,0x00, 0x3C,0x00, 0x6C,0x00, 0x7E,0x00, 0x0C,0x00, 0x0C,0x00, 0x00,0x00,
    0x7E,0x00, 0x60,0x00, 0x7C,0x00, 0x06,0x00, 0x06,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x1C,0x00, 0x30,0x00, 0x60,0x00, 0x7C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x7E,0x00, 0x06,0x00, 0x0C,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3C,0x00, 0x00,0x00,
    0x3C,0x00, 0x66,0x00, 0x66,0x00, 0x3E,0x00, 0x06,0x00, 0x0C,0x00, 0x38,0x00, 0x00,0x00,
    /* 37: - */
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x7E,0x00,
    0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    /* 38: / */
    0x06,0x00, 0x0C,0x00, 0x18,0x00, 0x30,0x00,
    0x60,0x00, 0xC0,0x00, 0x80,0x00, 0x00,0x00,
    /* 39: : */
    0x00,0x00, 0x18,0x00, 0x18,0x00, 0x00,0x00,
    0x18,0x00, 0x18,0x00, 0x00,0x00, 0x00,0x00,
};

#define FONT_SIZE (40 * 16)

/* Pre-encoded messages (tile indices) */
/* "SNESMOD MUSIC EXAMPLE" */
static const u8 msg_title[] = { 19,14,5,19,13,15,4, 0, 13,21,19,9,3, 0, 5,24,1,13,16,12,5, 0xFF };
/* "CONTROLS:" */
static const u8 msg_controls[] = { 3,15,14,20,18,15,12,19,39, 0xFF };
/* "A - PLAY MUSIC" */
static const u8 msg_a[] = { 1, 0,37,0, 16,12,1,25, 0, 13,21,19,9,3, 0xFF };
/* "B - STOP MUSIC" */
static const u8 msg_b[] = { 2, 0,37,0, 19,20,15,16, 0, 13,21,19,9,3, 0xFF };
/* "X - PAUSE/RESUME" */
static const u8 msg_x[] = { 24, 0,37,0, 16,1,21,19,5,38,18,5,19,21,13,5, 0xFF };
/* "L/R - VOLUME DOWN/UP" */
static const u8 msg_lr[] = { 12,38,18, 0,37,0, 22,15,12,21,13,5, 0, 4,15,23,14,38,21,16, 0xFF };
/* "START - FADE OUT" */
static const u8 msg_start[] = { 19,20,1,18,20, 0,37,0, 6,1,4,5, 0, 15,21,20, 0xFF };
/* "NOW PLAYING: POLLEN8" */
static const u8 msg_playing[] = { 14,15,23, 0, 16,12,1,25,9,14,7,39, 0, 16,15,12,12,5,14,35, 0xFF };

static void print_msg(u16 addr, const u8 *msg) {
    u16 i;
    REG_VMADDL = addr & 0xFF;
    REG_VMADDH = addr >> 8;
    i = 0;
    while (msg[i] != 0xFF) {
        REG_VMDATAL = msg[i];
        REG_VMDATAH = 0;
        i++;
    }
}

int main(void) {
    u16 pad;
    u16 pad_pressed;
    u16 pad_prev;
    u8 volume;
    u8 paused;
    u16 i;

    /* Initialize console hardware */
    consoleInit();

    /* Set Mode 0 (4 BG layers, all 2bpp) */
    setMode(BG_MODE0, 0);

    /* Configure BG1 for text display */
    REG_BG1SC = 0x04;   /* Tilemap at $0400, 32x32 */
    REG_BG12NBA = 0x00; /* BG1 tiles at $0000 */

    /* Load font tiles to VRAM $0000 */
    REG_VMAIN = 0x80;
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x00;
    for (i = 0; i < FONT_SIZE; i += 2) {
        REG_VMDATAL = font_tiles[i];
        REG_VMDATAH = font_tiles[i + 1];
    }

    /* Set palette */
    REG_CGADD = 0;
    REG_CGDATA = 0x00; REG_CGDATA = 0x28;  /* Dark blue */
    REG_CGDATA = 0xFF; REG_CGDATA = 0x7F;  /* White */

    /* Clear tilemap */
    REG_VMADDL = 0x00;
    REG_VMADDH = 0x04;
    for (i = 0; i < 1024; i++) {
        REG_VMDATAL = 0;
        REG_VMDATAH = 0;
    }

    /* Print messages */
    print_msg(0x0400 + 2*32 + 5, msg_title);
    print_msg(0x0400 + 5*32 + 5, msg_controls);
    print_msg(0x0400 + 7*32 + 7, msg_a);
    print_msg(0x0400 + 8*32 + 7, msg_b);
    print_msg(0x0400 + 9*32 + 7, msg_x);
    print_msg(0x0400 + 10*32 + 7, msg_lr);
    print_msg(0x0400 + 11*32 + 7, msg_start);
    print_msg(0x0400 + 14*32 + 5, msg_playing);

    /* Enable BG1 on main screen */
    REG_TM = TM_BG1;

    /* Initialize SNESMOD */
    snesmodInit();
    snesmodSetSoundbank(SOUNDBANK_BANK);
    snesmodLoadModule(MOD_POLLEN8);
    snesmodPlay(0);

    /* Turn on screen */
    setScreenOn();

    /* Initialize variables */
    volume = 127;
    paused = 0;

    /* Initialize pad_prev */
    WaitForVBlank();
    while (REG_HVBJOY & 0x01) {}
    pad_prev = REG_JOY1L | (REG_JOY1H << 8);

    /* Main loop */
    while (1) {
        WaitForVBlank();
        snesmodProcess();

        while (REG_HVBJOY & 0x01) {}
        pad = REG_JOY1L | (REG_JOY1H << 8);
        pad_pressed = pad & ~pad_prev;
        pad_prev = pad;

        if (pad == 0xFFFF) pad_pressed = 0;

        if (pad_pressed & KEY_A) {
            snesmodPlay(0);
            paused = 0;
        } else if (pad_pressed & KEY_B) {
            snesmodStop();
        }

        if (pad_pressed & KEY_X) {
            if (paused) { snesmodResume(); paused = 0; }
            else { snesmodPause(); paused = 1; }
        }

        if (pad_pressed & KEY_L) {
            if (volume > 10) { volume -= 10; snesmodSetModuleVolume(volume); }
        }
        if (pad_pressed & KEY_R) {
            if (volume < 117) { volume += 10; snesmodSetModuleVolume(volume); }
        }

        if (pad_pressed & KEY_START) {
            snesmodFadeVolume(0, 4);
        }
    }

    return 0;
}
