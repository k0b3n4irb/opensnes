/*
 * MetaSprite - PVSnesLib example ported to OpenSNES
 *
 * Demonstrates multi-size metasprites over a background:
 *   - 32x32 hero sprite (using OBJ_LARGE with OBJ_SIZE16_L32)
 *   - 16x16 hero sprite (using OBJ_SMALL with OBJ_SIZE16_L32)
 *   - 8x8 hero sprite (also using OBJ_SMALL tiles)
 *
 * OBJ_SIZE16_L32 = small sprites are 16x16, large sprites are 32x32
 * Metasprite tables are generated by gfx4snes -T and included directly.
 */

#include <snes.h>

/* Background assets */
extern u8 bg_tiles[], bg_tiles_end[];
extern u8 bg_map[], bg_map_end[];
extern u8 bg_pal[], bg_pal_end[];

/* Sprite tile data (from data.asm) */
extern u8 spr32_tiles[], spr32_tiles_end[];
extern u8 spr32_pal[];
extern u8 spr16_tiles[], spr16_tiles_end[];
extern u8 spr16_pal[];
extern u8 spr8_tiles[], spr8_tiles_end[];
extern u8 spr8_pal[];

/* Metasprite tables (generated by gfx4snes -T) */
#include "res/spritehero32_meta.inc"
#include "res/spritehero16_meta.inc"
#include "res/spritehero8_meta.inc"

int main(void) {
    consoleInit();

    /* Load background */
    bgInitTileSet(0, bg_tiles, bg_pal, 0,
                  bg_tiles_end - bg_tiles, bg_pal_end - bg_pal,
                  BG_16COLORS, 0x4000);
    bgSetMapPtr(0, 0x6800, BG_MAP_32x32);

    WaitForVBlank();
    dmaCopyVram(bg_map, 0x6800, bg_map_end - bg_map);

    /* Init sprites: small=16x16, large=32x32 */
    REG_INIDISP = 0x80; /* Force blank for VRAM writes */
    oamInitEx(OBJ_SIZE16_L32, 0x0000);

    /* Load sprite palettes to CGRAM OBJ palette 0 (color 128+) */
    dmaCopyCGram(spr32_pal, 128, 16 * 2);

    /* Load 32x32 sprite tiles at VRAM $0000 */
    dmaCopyVram(spr32_tiles, 0x0000, spr32_tiles_end - spr32_tiles);

    /* Load 16x16 sprite tiles after 32x32 tiles */
    dmaCopyVram(spr16_tiles, 0x1000, spr16_tiles_end - spr16_tiles);

    REG_INIDISP = 0x0F;

    setMode(BG_MODE1, 0);
    REG_TM = TM_BG1 | TM_OBJ;
    setScreenOn();

    /* Draw metasprites at fixed positions */

    /* 32x32 hero at position (16, 140), using large sprites, base tile 0 */
    oamDrawMeta(0, 16, 140,
                spritehero32_metasprites[0],
                0, 0, OBJ_LARGE);

    /* 16x16 hero at position (100, 140), using small sprites, base tile 0 */
    oamDrawMeta(16, 100, 140,
                spritehero16_metasprites[0],
                0, 0, OBJ_SMALL);

    /* 8x8 hero at position (200, 140) -- note: 8x8 tiles need OBJ_SIZE8_L16 mode
     * but we are in OBJ_SIZE16_L32 mode, so 8x8 metasprites will use small (16x16)
     * sprites. The spritehero8 meta uses 8-pixel offsets that work within 16x16. */
    oamDrawMeta(32, 200, 140,
                spritehero8_metasprites[0],
                0, 0, OBJ_SMALL);

    oamUpdate();

    while (1) {
        WaitForVBlank();
    }
    return 0;
}
