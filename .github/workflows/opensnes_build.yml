name: OpenSNES Build & Release

# ------------------------------------ #
# Events to trigger the action         #
# ------------------------------------ #
on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "develop"
  pull_request:
    branches:
      - "main"
      - "develop"

# ------------------------------------ #
# Set O.S matrix                       #
# ------------------------------------ #
jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
          - os: windows-latest
            name: windows
          - os: macos-latest
            name: darwin

    steps:
      # ------------------------------------ #
      # Install dependencies                 #
      # ------------------------------------ #
      - name: Install dependencies for Linux
        if: matrix.name == 'linux'
        run: |
          sudo apt update -y
          sudo apt-get install -y build-essential \
              clang \
              cmake \
              make \
              git \
              doxygen \
              zip

      - name: Install dependencies for Windows
        if: matrix.name == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: UCRT64
          install: >-
            mingw-w64-ucrt-x86_64-clang
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-doxygen
            mingw-w64-ucrt-x86_64-python
            base-devel
            git
            zip

      - name: Install dependencies for macOS
        if: matrix.name == 'darwin'
        run: |
          brew update || true
          brew install doxygen zip || true
          # Xcode Command Line Tools provides the compiler

      # ------------------------------------ #
      # Checkout the project                 #
      # ------------------------------------ #
      - name: Check out OpenSNES
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------------------------------ #
      # Build & create release               #
      # ------------------------------------ #
      - name: Build & Release OpenSNES for Linux
        if: matrix.name == 'linux'
        run: |
          export OPENSNES_HOME=$(pwd)
          make release 2>&1 | tee opensnes_release_${{ matrix.name }}.log

      - name: Build & Release OpenSNES for Windows
        if: matrix.name == 'windows'
        continue-on-error: true  # cproc may intermittently crash on MSYS2 (text.c HiROM)
        shell: msys2 {0}
        run: |
          set -o pipefail
          export OPENSNES_HOME=$(pwd)
          make release 2>&1 | tee opensnes_release_${{ matrix.name }}.log

      - name: Build & Release OpenSNES for macOS
        if: matrix.name == 'darwin'
        run: |
          export OPENSNES_HOME=$(pwd)
          make release 2>&1 | tee opensnes_release_${{ matrix.name }}.log

      # ------------------------------------ #
      # Build and run tests                  #
      # ------------------------------------ #
      - name: Build tests (Linux/macOS)
        if: matrix.name != 'windows'
        run: |
          set -o pipefail
          make tests 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Build tests (Windows)
        if: matrix.name == 'windows'
        continue-on-error: true  # cproc segfaults on some C constructs on MSYS2
        shell: msys2 {0}
        run: |
          set -o pipefail
          make tests 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      # ------------------------------------ #
      # Run compiler tests                   #
      # ------------------------------------ #
      - name: Run compiler tests (Linux/macOS)
        if: matrix.name != 'windows'
        run: |
          set -o pipefail
          echo "=== Compiler Tests ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/compiler/run_tests.sh 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Run compiler tests (Windows)
        if: matrix.name == 'windows'
        continue-on-error: true  # cproc segfaults non-deterministically on MSYS2
        shell: msys2 {0}
        run: |
          set -o pipefail
          echo "=== Compiler Tests ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/compiler/run_tests.sh --allow-known-bugs 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      # ------------------------------------ #
      # Build and validate examples          #
      # ------------------------------------ #
      - name: Build examples (Linux/macOS)
        if: matrix.name != 'windows'
        run: |
          set -o pipefail
          echo "=== Building Examples ===" | tee -a opensnes_release_${{ matrix.name }}.log
          make examples 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Build examples (Windows)
        if: matrix.name == 'windows'
        continue-on-error: true  # cproc may intermittently crash on MSYS2
        shell: msys2 {0}
        run: |
          set -o pipefail
          echo "=== Building Examples ===" | tee -a opensnes_release_${{ matrix.name }}.log
          make examples 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Validate examples (Linux/macOS)
        if: matrix.name != 'windows'
        run: |
          set -o pipefail
          echo "=== Validating Examples ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/examples/validate_examples.sh --quick 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Validate examples (Windows)
        if: matrix.name == 'windows'
        continue-on-error: true  # depends on examples building successfully
        shell: msys2 {0}
        run: |
          set -o pipefail
          echo "=== Validating Examples ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/examples/validate_examples.sh --quick 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      # ------------------------------------ #
      # Check memory overlaps                #
      # ------------------------------------ #
      - name: Check memory overlaps (Linux/macOS)
        if: matrix.name != 'windows'
        run: |
          set -o pipefail
          echo "=== Memory Overlap Check ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/ci/check_memory_overlaps.sh 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      - name: Check memory overlaps (Windows)
        if: matrix.name == 'windows'
        continue-on-error: true  # depends on examples building successfully
        shell: msys2 {0}
        run: |
          set -o pipefail
          echo "=== Memory Overlap Check ===" | tee -a opensnes_release_${{ matrix.name }}.log
          ./tests/ci/check_memory_overlaps.sh 2>&1 | tee -a opensnes_release_${{ matrix.name }}.log

      # ------------------------------------ #
      # Check library linking                #
      # ------------------------------------ #
      - name: Check library linking (macOS)
        if: matrix.name == 'darwin'
        run: |
          echo "=== Library Linking ===" | tee opensnes_linking_${{ matrix.name }}.log
          otool -L bin/* 2>/dev/null | tee -a opensnes_linking_${{ matrix.name }}.log || true

      - name: Check library linking (Linux)
        if: matrix.name == 'linux'
        run: |
          echo "=== Library Linking ===" | tee opensnes_linking_${{ matrix.name }}.log
          ldd bin/* 2>/dev/null | tee -a opensnes_linking_${{ matrix.name }}.log || true

      - name: Check library linking (Windows)
        if: matrix.name == 'windows'
        shell: msys2 {0}
        run: |
          echo "=== Library Linking ===" | tee opensnes_linking_${{ matrix.name }}.log
          ldd bin/*.exe 2>/dev/null | tee -a opensnes_linking_${{ matrix.name }}.log || true

      # ------------------------------------ #
      # Upload SDK release                   #
      # ------------------------------------ #
      - name: Upload OpenSNES SDK release
        uses: actions/upload-artifact@v4
        with:
          name: OpenSNES SDK (${{ matrix.name }})
          path: release/opensnes_${{ matrix.name }}.zip

      # ------------------------------------ #
      # Upload build logs                    #
      # ------------------------------------ #
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: OpenSNES Logs (${{ matrix.name }})
          path: "*.log"

