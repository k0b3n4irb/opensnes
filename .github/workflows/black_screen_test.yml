name: Black Screen Test

# ------------------------------------ #
# Separate workflow for ROM validation #
# using Mesen2 emulator               #
# ------------------------------------ #

env:
  MESEN_VERSION: "2.1.1"

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "develop"
  pull_request:
    branches:
      - "main"
      - "develop"

jobs:
  black-screen-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true

    steps:
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt-get install -y build-essential clang cmake make git \
              xvfb libsdl2-2.0-0

      - name: Check out OpenSNES
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Mesen emulator
        id: cache-mesen
        uses: actions/cache@v4
        with:
          path: ~/mesen
          key: mesen-${{ env.MESEN_VERSION }}-linux-x64

      - name: Download Mesen
        if: steps.cache-mesen.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/mesen
          curl -sL "https://github.com/SourMesen/Mesen2/releases/download/${{ env.MESEN_VERSION }}/Mesen_${{ env.MESEN_VERSION }}_Linux_x64.zip" -o /tmp/mesen.zip
          unzip /tmp/mesen.zip -d ~/mesen
          chmod +x ~/mesen/Mesen
          ls -la ~/mesen/

      # Build only hello_world (fastest example to compile)
      - name: Build SDK and single example
        run: |
          set -o pipefail
          export OPENSNES_HOME=$(pwd)
          make 2>&1 | tail -5
          make -C examples/text/1_hello_world 2>&1 | tail -5
          ls -la examples/text/1_hello_world/*.sfc

      # Single-ROM diagnostic: try 4 headless methods
      - name: Diagnose Mesen2 headless (single ROM)
        run: |
          MESEN="$HOME/mesen/Mesen"
          ROM="examples/text/1_hello_world/hello_world.sfc"
          LUA="tests/black_screen_test.lua"

          echo "=== Mesen2 v${{ env.MESEN_VERSION }} headless diagnostics ==="
          echo "Binary: $(file "$MESEN" | cut -d: -f2)"
          echo "ROM:    $ROM ($(stat -c%s "$ROM") bytes)"
          echo ""

          echo "--- Dependencies ---"
          ldd "$MESEN" 2>&1 | grep -i "not found" || echo "OK: all shared libs found"
          echo ""

          for i in 1 2 3 4; do
            case $i in
              1) DESC="SDL_VIDEODRIVER=dummy";  CMD="env SDL_VIDEODRIVER=dummy SDL_AUDIODRIVER=dummy timeout 15 $MESEN --testrunner --enablestdout $ROM $LUA" ;;
              2) DESC="SDL_VIDEODRIVER=offscreen"; CMD="env SDL_VIDEODRIVER=offscreen SDL_AUDIODRIVER=dummy timeout 15 $MESEN --testrunner --enablestdout $ROM $LUA" ;;
              3) DESC="xvfb-run";               CMD="xvfb-run timeout 15 $MESEN --testrunner --enablestdout $ROM $LUA" ;;
              4) DESC="xvfb + no-audio";        CMD="env SDL_AUDIODRIVER=dummy xvfb-run timeout 15 $MESEN --testrunner --enablestdout $ROM $LUA" ;;
            esac
            echo "--- Test $i: $DESC ---"
            EXIT=0
            eval $CMD > /tmp/test$i.txt 2>&1 || EXIT=$?
            SIZE=$(wc -c < /tmp/test$i.txt)
            echo "exit=$EXIT  output=${SIZE}B"
            if [ "$SIZE" -gt 0 ]; then
              echo "--- output ---"
              cat /tmp/test$i.txt
              echo "--- end ---"
            fi
            echo ""
          done

          echo "=== SUMMARY ==="
          printf "%-30s  exit  output\n" "Method"
          for i in 1 2 3 4; do
            case $i in
              1) DESC="SDL dummy" ;;
              2) DESC="SDL offscreen" ;;
              3) DESC="xvfb-run" ;;
              4) DESC="xvfb + no-audio" ;;
            esac
            # Re-read exit codes from output
            SIZE=$(wc -c < /tmp/test$i.txt)
            printf "%-30s  %s\n" "$DESC" "${SIZE}B"
          done
