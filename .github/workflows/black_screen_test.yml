name: Black Screen Test

# ------------------------------------ #
# Separate workflow for ROM validation #
# using Mesen2 emulator               #
# ------------------------------------ #

env:
  MESEN_VERSION: "2.1.1"

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "develop"
  pull_request:
    branches:
      - "main"
      - "develop"

jobs:
  black-screen-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt-get install -y build-essential clang cmake make git \
              xvfb libsdl2-dev

      - name: Install .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Check out OpenSNES
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache the built Mesen2 to avoid rebuilding every time
      - name: Cache Mesen build
        id: cache-mesen
        uses: actions/cache@v4
        with:
          path: ~/mesen-build
          key: mesen-build-${{ env.MESEN_VERSION }}-ubuntu2404-net8

      # Build Mesen2 from source as framework-dependent (.NET).
      # The NativeAOT release binary crashes with std::bad_cast in
      # testrunner mode â€” building from source avoids this issue.
      - name: Build Mesen from source
        if: steps.cache-mesen.outputs.cache-hit != 'true'
        run: |
          set -o pipefail
          git clone --depth 1 --branch "$MESEN_VERSION" \
            https://github.com/SourMesen/Mesen2.git ~/mesen-src 2>&1 || \
          git clone --depth 1 https://github.com/SourMesen/Mesen2.git ~/mesen-src 2>&1
          cd ~/mesen-src
          make 2>&1 | tail -20
          mkdir -p ~/mesen-build
          cp -r bin/linux-x64/Release/net8.0/publish/* ~/mesen-build/ 2>/dev/null || \
          cp -r bin/linux-x64/Release/net8.0/* ~/mesen-build/ 2>/dev/null || \
          cp -r bin/*/*/net*/* ~/mesen-build/
          ls -la ~/mesen-build/

      # Build only hello_world (fastest example to compile)
      - name: Build SDK and single example
        run: |
          set -o pipefail
          export OPENSNES_HOME=$(pwd)
          make 2>&1 | tail -5
          make -C examples/text/1_hello_world 2>&1 | tail -5
          ls -la examples/text/1_hello_world/*.sfc

      # Pre-create config to skip first-run wizard
      - name: Pre-create Mesen config
        run: |
          mkdir -p ~/.config/Mesen2
          echo 'FORCE_DEFAULTS' > ~/.config/Mesen2/settings.json

      - name: Run black screen test
        run: |
          ROM="examples/text/1_hello_world/hello_world.sfc"
          LUA="tests/black_screen_test.lua"

          echo "=== Mesen2 testrunner (framework-dependent build) ==="
          echo "ROM: $ROM ($(stat -c%s "$ROM") bytes)"
          echo ""

          # Test 1: No display (testrunner should bypass Avalonia)
          echo "--- Test 1: No display ---"
          EXIT=0
          env SDL_VIDEODRIVER=dummy SDL_AUDIODRIVER=dummy \
            timeout 20 dotnet ~/mesen-build/Mesen.dll \
            --testrunner --enablestdout "$ROM" "$LUA" \
            > /tmp/test1.txt 2>&1 || EXIT=$?
          echo "exit=$EXIT  output=$(wc -c < /tmp/test1.txt)B"
          cat /tmp/test1.txt 2>/dev/null
          echo "---"

          # Test 2: xvfb + no audio
          echo "--- Test 2: xvfb + no-audio ---"
          EXIT=0
          env SDL_AUDIODRIVER=dummy \
            xvfb-run --auto-servernum -- \
            timeout 20 dotnet ~/mesen-build/Mesen.dll \
            --testrunner --enablestdout "$ROM" "$LUA" \
            > /tmp/test2.txt 2>&1 || EXIT=$?
          echo "exit=$EXIT  output=$(wc -c < /tmp/test2.txt)B"
          cat /tmp/test2.txt 2>/dev/null
          echo "---"

          # Summary
          echo ""
          echo "=== RESULTS ==="
          for i in 1 2; do
            if grep -q "BLACKTEST_RESULT:" /tmp/test$i.txt 2>/dev/null; then
              RESULT=$(grep "BLACKTEST_RESULT:" /tmp/test$i.txt | tail -1)
              echo "Test $i: $RESULT"
            else
              echo "Test $i: NO RESULT"
            fi
          done
