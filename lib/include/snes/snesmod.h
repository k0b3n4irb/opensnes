/**
 * @file snesmod.h
 * @brief SNESMOD - Tracker-based Audio Engine
 *
 * A full-featured audio engine for SNES supporting:
 * - Impulse Tracker module playback (up to 8 channels)
 * - Sound effects with priority and mixing
 * - Echo/reverb effects
 * - Volume fading and position synchronization
 *
 * ## Quick Start
 *
 * @code
 * #include <snes.h>
 * #include <snes/snesmod.h>
 * #include "soundbank.h"  // Generated by smconv
 *
 * extern u8 soundbank[];
 *
 * int main(void) {
 *     // Initialize video...
 *
 *     snesmodInit();
 *     snesmodSetSoundbank(soundbank);
 *     snesmodLoadModule(MOD_MUSIC);  // From soundbank.h
 *     snesmodPlay(0);
 *
 *     while (1) {
 *         WaitForVBlank();
 *         snesmodProcess();  // MUST call every frame!
 *
 *         if (padPressed(0) & KEY_A) {
 *             snesmodPlayEffect(SFX_JUMP, 127, 128, 0x1000);
 *         }
 *     }
 * }
 * @endcode
 *
 * ## Soundbank Creation
 *
 * Use smconv to create soundbanks from Impulse Tracker files:
 * @code
 * smconv -s -o soundbank music.it effects.it
 * @endcode
 *
 * This generates:
 * - soundbank.asm - Assembly data to link with ROM
 * - soundbank.h - Module/effect ID constants
 *
 * ## Memory Usage
 *
 * - SPC700 driver: ~5.5KB
 * - Sample data: up to ~58KB
 * - Echo buffer: 4KB (at $D000-$FFFF)
 *
 * @note The snesmodProcess() function MUST be called every frame!
 *       Failure to do so will cause audio glitches.
 *
 * @author Original SNESMod by mukunda
 * @author WLA-DX port by KungFuFurby
 * @author Adapted for OpenSNES
 * @copyright zlib license
 */

#ifndef OPENSNES_SNESMOD_H
#define OPENSNES_SNESMOD_H

#include <snes/types.h>

/*============================================================================
 * Initialization
 *============================================================================*/

/**
 * @defgroup snesmod_init Initialization
 * @{
 */

/**
 * @brief Initialize SNESMOD audio engine
 *
 * Uploads the SPC700 driver via IPL protocol.
 * Call once during game initialization, before any other snesmod functions.
 *
 * @note Interrupts are disabled during upload.
 * @note Takes several frames to complete.
 */
void snesmodInit(void);

/**
 * @brief Set the soundbank bank number
 *
 * Sets which ROM bank contains the soundbank data generated by smconv.
 * In LoROM, soundbanks always start at $8000 within their bank.
 *
 * @param bank Bank number where soundbank is located (e.g., 1 for bank $01)
 *
 * @code
 * #include "soundbank.h"  // Generated by smconv
 * snesmodSetSoundbank(SOUNDBANK_BANK);  // Usually 1
 * @endcode
 */
void snesmodSetSoundbank(u8 bank);

/** @} */

/*============================================================================
 * Module Playback
 *============================================================================*/

/**
 * @defgroup snesmod_module Module Playback
 * @{
 */

/**
 * @brief Load a module from the soundbank
 *
 * Loads module data and all associated samples to SPC RAM.
 * This is a blocking operation that may take multiple frames.
 *
 * @param moduleId Module ID from soundbank.h
 *
 * @code
 * snesmodLoadModule(MOD_LEVEL1_MUSIC);
 * @endcode
 */
void snesmodLoadModule(u16 moduleId);

/**
 * @brief Start module playback
 *
 * Begins playing the currently loaded module.
 *
 * @param startPosition Starting row/position in the module (usually 0)
 */
void snesmodPlay(u8 startPosition);

/**
 * @brief Stop module playback
 *
 * Immediately stops all module playback.
 */
void snesmodStop(void);

/**
 * @brief Pause module playback
 *
 * Pauses playback without resetting position.
 */
void snesmodPause(void);

/**
 * @brief Resume module playback
 *
 * Resumes playback from where it was paused.
 */
void snesmodResume(void);

/**
 * @brief Get current module position
 *
 * Returns the current playback position (row number).
 * Useful for synchronizing game events to music.
 *
 * @return Current row/position
 */
u8 snesmodGetPosition(void);

/** @} */

/*============================================================================
 * Sound Effects
 *============================================================================*/

/**
 * @defgroup snesmod_sfx Sound Effects
 * @{
 */

/**
 * @brief Load a sound effect from the soundbank
 *
 * Loads a single source/sample for use as a sound effect.
 *
 * @param sfxIndex Source index in the soundbank
 * @return Effect slot ID for use with snesmodPlayEffect
 */
u8 snesmodLoadEffect(u16 sfxIndex);

/**
 * @brief Play a sound effect
 *
 * Triggers a sound effect, potentially interrupting module playback
 * on one channel temporarily.
 *
 * @param effectId Effect slot ID (from snesmodLoadEffect or soundbank.h)
 * @param volume Volume level (0-127)
 * @param pan Pan position (0=left, 128=center, 255=right)
 * @param pitch Pitch value ($1000 = normal, $2000 = octave up)
 * @return Channel used for effect
 *
 * @code
 * // Play jump sound at full volume, center pan, normal pitch
 * snesmodPlayEffect(SFX_JUMP, 127, 128, 0x1000);
 *
 * // Play with higher pitch
 * snesmodPlayEffect(SFX_JUMP, 127, 128, 0x1800);
 * @endcode
 */
u8 snesmodPlayEffect(u16 effectId, u8 volume, u8 pan, u16 pitch);

/** @} */

/*============================================================================
 * Volume Control
 *============================================================================*/

/**
 * @defgroup snesmod_volume Volume Control
 * @{
 */

/**
 * @brief Set module volume
 *
 * Sets the playback volume for the current module.
 *
 * @param volume Volume level (0-127)
 */
void snesmodSetModuleVolume(u8 volume);

/**
 * @brief Fade module volume
 *
 * Gradually fades the module volume to a target level.
 *
 * @param targetVolume Target volume (0-127)
 * @param speed Fade speed (higher = faster)
 *
 * @code
 * // Fade out before level transition
 * snesmodFadeVolume(0, 8);
 * @endcode
 */
void snesmodFadeVolume(u8 targetVolume, u8 speed);

/** @} */

/*============================================================================
 * Processing
 *============================================================================*/

/**
 * @defgroup snesmod_process Processing
 * @{
 */

/**
 * @brief Process audio commands
 *
 * @warning This function MUST be called every frame!
 *
 * Processes the command queue and handles streaming.
 * Failure to call this regularly will cause:
 * - Audio stuttering and dropouts
 * - Command buffer overflow
 * - Desynchronization with module playback
 *
 * Call in your main loop or NMI handler:
 * @code
 * while (1) {
 *     WaitForVBlank();
 *     snesmodProcess();
 *     // ... game logic
 * }
 * @endcode
 */
void snesmodProcess(void);

/**
 * @brief Wait for command queue to empty
 *
 * Blocks until all queued commands have been processed.
 * Useful before loading new modules.
 */
void snesmodFlush(void);

/** @} */

/*============================================================================
 * Streaming Audio
 *============================================================================*/

/**
 * @defgroup snesmod_stream Streaming Audio
 * @{
 */

/**
 * @brief Set the streaming sound table
 *
 * Points to a table of streaming sound descriptors.
 *
 * @param table Pointer to sound table data
 */
void snesmodSetSoundTable(const u8 *table);

/**
 * @brief Allocate SPC RAM for streaming buffer
 *
 * Reserves memory in SPC RAM for streaming audio.
 *
 * @param size Buffer size (in units specific to driver)
 */
void snesmodAllocateSoundRegion(u8 size);

/** @} */

/*============================================================================
 * Pitch Constants
 *============================================================================*/

/**
 * @defgroup snesmod_pitch Pitch Constants
 * @{
 */

/** @brief Standard pitch values */
#define SNESMOD_PITCH_NORMAL    0x1000  /**< Normal playback speed */
#define SNESMOD_PITCH_HALF      0x0800  /**< Half speed (octave down) */
#define SNESMOD_PITCH_DOUBLE    0x2000  /**< Double speed (octave up) */

/** @} */

#endif /* OPENSNES_SNESMOD_H */
